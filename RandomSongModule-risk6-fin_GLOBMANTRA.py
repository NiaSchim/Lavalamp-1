#-------------------------------------------------------------------------------
# Name:        LavalampParticles.py
# Purpose: pretty visualizer
#
# Author:      The Schim
#
# Created:     16/03/2023
# Copyright:   (c) The Schim 2023
# Licence:     CC0
#-------------------------------------------------------------------------------
import pygame
import random
import math
from colorsys import hsv_to_rgb, rgb_to_hsv
import uuid

# Constants
WIDTH, HEIGHT = 800, 600
BG_COLOR = (0, 0, 0)
FPS = 60
MIN_RADIUS = 33.3
MAX_RADIUS = 99.9
SPLIT_PROB = 0.29
DEPTH = 700
cooldown = random.randint(314, 6400)
INITIAL_GLOBS = 25
MAX_NUMBER_GLOBS = 115
SPEED_DIVISOR = 2.0+(1/math.pi)
AGE_FACTOR = 0.1
TRANSFER = 0.00075

from scipy.signal import firwin, lfilter
import numpy as np
import simpleaudio as sa
import scipy.signal
import threading
import time
import sounddevice as sd
import scipy.optimize as opt

# Define audio constants
SAMPLE_RATE = int(44100//100)
BIT_DEPTH = -16
NUM_CHANNELS = 2
AUDIO_BUFFER_SIZE = round(1024*2)
NUM_CHANNELS = 2  # mono audio with psuedo surround
AMPLITUDE = 3000 # maximum amplitude of the audio signal
PENTATONIC_SCALE = [2, 4, 6, 9, 11]  # pentatonic scale intervals in semitones
OCTAVES = 8  # number of octaves to span with the pentatonic scale
BASE_FREQ = 466.16 / FPS
SEMITONE_RATIO =  1.061803398874989484820458683436563811772030917980576286213544862270526046281890244970720720418939113748475408807538689175212663386222353693179318006076672635443338908659593958290563832266131992829026788067520876689250171169620703222104321626954862629631361443814975870122034080588795445474924618569536486444924104432077134494704956584678850987433944221254487706647809158846074998871240076521705751797883416625624940758906970400028121042762177111777805315317141011704666599146697987317613560067087480710131795236894275219484353056783002287856997829778347845878228911097625003026961561700250464338243776486102838312683303724292675263116533924731671112115881863851331620384005222165791286675294654906811317159934323597349498509040947621322298101726107059611645629909816290555208524790352406020172799747175342777592778625619432082750513121815628551222480939471234145170223735805772786160086883829523045926478780178899219902707769038953219681986151437803149974110692608867429622675756052317277752035361393621076738937645560606059216589466759551900400555908950229530942312482355212212415444006470340565734797663972394949946584578873039623090375033993856210242369025138680414577995698122445747178034173126453220416397232134044449487302315417676893752103068737880344170093954409627955898678723209512426893557309704509595684401755519881921802064052905518934947592600734852282101088194644544222318891319294689622002301443770269923007803085261180754519288770502109684249362713592518760777884665836150238913493333122310533923213624319263728910670503399282265263556209029798642472759772565508615487543574826471814145127000602389016207773224499435308899909501680328112194320481964387675863314798571911397815397807476150772211750826945863932045652098969855567814106968372884058746103378105444390943683583581381131168993855576975484149144534150912954070050194775486163075422641729394680367319805861833918328599130396072014455950449779212076124785645916160837059498786006970189409886400764436170933417270919143365013715766011480381430626238051432117348151005590134561011800790506381421527093085880928757034505078081454588199063361298279814117453392731208092897279222132980642946878242748740174505540677875708323731097591511776297844328474790817651809778726841611763250386121129143683437670235037111633072586988325871033632223810980901211019899176841491751233134015273384383723450093478604979294599158220125810459823092552872124137043614910205471855496118087642657651106054588147560443178479858453973128630162544876114852021706440411166076695059775783257039511087823082710647893902111569103927683845386333321565829659773103436032322545743637204124406408882673758433953679593123221343732099574988946995656473600729599983912881031974263125179714143201231127955189477817269141589117799195648125580018455065632952859859100090862180297756378925999164994642819302229355234667475932695165421402109136301819472270789012208728736170734864999815625547281137347987165695274890081443840532748378137824669174442296349147081570073525457070897726754693438226195468615331209533579238014609273510210119190218360675097308957528957746814229543394385493155339630380729169175846101460995055064803679304147236572039860073550760902317312501613204843583648177048481810991602442523271672190189334596378608787528701739359303013359011237102391712659047026349402830766876743638651327106280323174069317334482343564531850581353108549733350759966778712449058363675413289086240632456395357212524261170278028656043234942837301725574405837278267996031739364013287627701243679831144643694767053127249241047167001382478312865650649343418039004101780533950587724586655755229391582397084177298337282311525692609299594224000056062667867435792397245408481765197343626526894488855272027477874733598353672776140759171205132693448375299164998093602461784426757277679001919190703805220461232482391326104327191684512306023627893545432461769975753689041763650254785138246314658336383376023577899267298863216185839590363998183845827644912459809370430555596137973432613483049494968681089535696348281781288625364608420339465381944194571426668237183949183237090857485026656803989744066210536030640026081711266599541993687316094572288810920778822772036366844815325617284117690979266665522384688311371852991921631905201568631222820715599876468423552059285371757807656050367731309751912239738872246825805715974457404842987807352215984266766257807706201943040054255015831250301753409411719101929890384472503329880245014367968441694795954530459103138116218704567997866366174605957000344597011352518134600656553520347888117414994127482641521355677639403907103870881823380680335003804680017480822059109684420264464021877053401003180288166441530913939481564031928227854824145105031888251899700748622879421558957428202166570621880905780880503246769912972872103870736974064356674589202586565739785608595665341070359978320446336346485489497663885351045527298242290699848853696828046459745762651434359050938321243743333870516657149005907105670248879858043718151261004403814880407252440616429022478227152724112085065788838712493635106806365166743222327767755797399270376231914704732395512060705503992088442603708790843334261838413597078164829553714321961189503797714630007555975379570355227144931913217255644012830918050450089921870512118606933573153895935079030073672702331416532042340155374144268715405511647961143323024854404094069114561398730260395182816803448252543267385759005604320245372719291248645813334416985299391357478698957986439498023047116967157362283912018127312916589952759919220318372356827279385637331265479985912463275030060592567454979435088119295056854932593553187291418011364121874707526281068698301357605247194455932195535961045283031488391176930119658583431442489489856558425083410942950277197583352244291257364938075417113739243760143506829878493271299751228688196049835775158771780410697131966753477194792263651901633977128473907933611119140899830560336106098717178305543540356089529290818464143713929437813560482038947912574507707557510300242072662900180904229342494259060666141332287226980690145994511995478016399151412612525728280664331261657469388195106442167387180001100421848302580916543383749236411838885646851431500637319042951481469424314608952547072037405566913069220990804819452975110650464281054177552590951871318883591476599604131796020941530858553323877253802327276329773721431279682167162344211832018028814127474431688472184593927814354740999990722332030592629766112383279833169882539312620065037028844782866694044730794710476125586583752986236250999823233597155072338383324408152577819336426263043302658958170800451278873115935587747217256494700051636672577153920984095032745112153687300912199629522765913163709396860727134269262315475330437993316581107369643142171979434056391551210810813626268885697480680601169189417502722987415869917914534994624441940121978586013736608286907223651477139126874209665137875620591854328888341742920901563133283193575622089713765630978501563154982456445865424792935722828750608481453351352181729587932991171003247622205219464510536245051298843087134443950724426735146286179918323364598369637632722575691597239543830520866474742381511079273494836952396479268993698324917999502789500060459661313463363024949951480805329017902975182515875049007435187983511836032722772601717404535571658855578297291061958193517105548257930709100576358699019297217995168731175563144485648100220014254540554292734588371160209947945720823780436871894480563689182580244499631878342027491015335791072733625328906933474123802222011626277119308544850295419132004009998655666517756640953656197897818380451030356510131589458902871861086905893947136801484570018366495647203294334374298946427412551435905843484091954870152361403173913903616440198455051049121169792001201999605069949664030350863692903941007019450532016234872763232732449439630480890554251379723314751852070910250636859816795304818100739424531700238804759834323450414258431406361272109602282423378228090279765960777108493915174887316877713522390091171173509186006546200990249758527792542781659703834950580106261553336910937846597710529750223173074121778344189411845965861029801877874274456386696612772450384586052641510304089825777754474115332076407588167751497553804711629667771005876646159549677692705496239398570925507027406997814084312496536307186653371806058742242598165307052573834541577054292162998114917508611311765773172095615656478695474489271320608063545779462414531066983742113798168963823533304477883169339728728918103664083269856988254438516675862289930696434684897514840879039647604203610206021717394470263487633654393195229077383616738981178124248365578105034169451563626043003665743108476654877780128577923645418522447236171374229255841593135612866371670328072171553392646325730673063910854108868085742838588280602303341408550390973538726134511962926415995212789311354431460152730902553827104325966226743903745563612286139078319433570590038148700898661315398195857442330441970856696722293142730741384882788975588860799738704470203166834856941990965480298249319817657926829855629723010682777235162740783807431877827318211919695280051608791572128826337968231272562870001500182929757729993579094919640763442861575713544427898383040454702710194580042582021202344580630345033658147218549203679989972935353919681213319516537974539911149424445183033858841290401817818821376006659284941367754317451605409387110368715211640405821934471204482775960541694864539878326269548013915019038995931306703186616706637196402569286713887146631189192685682691995276457997718278759460961617218868109454651578869122410609814197268619255478789926315359472922825080542516906814010781796021885330762305563816316401922454503257656739259976517530801427160714308718862859836037465057134204670083432754230277047793311183666903232885306873879907135900740304907459889513647687608678443238248218930617570319563803230819719363567274196438726258706154330729637038127515170406005057594882723856345156390526577104264594760405569509598408889037620799566388017861855915944111725092313279771138032943765475090165169496509916073833937715833230245701948347400070437618671998483401631826008462619656284649118225688857521346375490254180833821383522245258726789379505375915603579454698509102256225455003017571049469833483545323835260787092219304581782306012370753280678368541306584636788866433486249368010198782799630670259543265137806007386392908564830874157618741897345848450141889765293411013722158643559915527113623322003526677859159890231446163321026519665907632061524383747619049531582968836265042094840105654589130629827717249809641959472340465110419821347689354018038256954956286039244264159867485982280060353862839166201252826607493306196584965199979419393226017235710733642537083033011433624985753635970424446475998999950855041354977558585934576590926533307252775416758431466936767806170350120038448748838233760344077515947781221883070900087386627362091660799050226989270321899760379509890591085910392967345614610700304581921273892599269610621167643642438350141020408632149917815297968152237983224273753657008553469979655413859050326836160222788475547062698439108852103020768604706804556846560491686498860616222952323907098092629302337956482179981632645827888877674520846371971063478923106675469355047615197781699025881840407927510901824482787052505976983753514306224450902202382439823125505841623207188319300693606464682096595006549290109716186526367216107417136183776673327975626854801245657682790317603946555394523143387567730349791578588591011663748455675847952713918608782540104233329857442747118969610485126401975043599092076621558998660736837623188358845081292950114665354828171448464056865246540907815471619625784469575262569455165601519164029217988548909373280314651922247590030965715490505361043776868772619159528449204647868973473708598413845131621192972012634240773694545981865029659233534512568454974541129819735876670728601616056204230636066130281496773445797737750557564665475256322648177116997857087122831543104569123262503497681152452174497396136748822046480519688754341969511933120450216051429384844754523821270143830957855813619678302310685080845876952059053294683384904712099162556365034003439670828933698367423001575117385151269123066172276414421607512917341874714315093241924914160969998672815823859257359823894849274919646152272273338746312138436262116379467062032630225055489580573083750461299231136299173069489407342588319483999274163950984439634057635284717562762192786522539608720131080486406534396168875452534263098969517619019770963192258709342165955974471750157538376741522280570650280683143356524917199733358403064153550759115974264366482846628136802174505909705894602744292632222215459450758046571206068639904308236939693208237490767561190171561305424813311715242568478463363770015204417916501168232575236160495749706390822443444510351219048819830276001766809850965245439007199098034993026860675523879685292194732393352370086650221407464554037222343481675749373144640928379006539196774010355861936181566836616864892395554961452826472894994160615803045867891461971728155451100056660542499691974102798740593276434953714525167694620698597880946950174730228414275718871940921209137994059430370504364838600434645227993302923901865922689874992113256560557840142335426058951056203690720289393159204404768359276364799600596404860761989159298194950878786027663459905404263770045900803279434720629825445256356479542992488198646136171314485773469953475577155491384239289401754034139973846169481293479242234609743019627523013828607224496380953838401526567819764507588547855155492345234781646033062938842009950803260140918302574385770671025227243666905988908545015570754230316665924723528924702588624794887546252765727285151112878270673454310244515233456542284311039679528296250193698939983473961763988095735415260145372964681473821843600521099472119416591494716705203792255209633645848468041447780302164728623999264048363508773747824501638200895240322534379925790129265640155537754091751704419627285039126695956664877242967660367303453668734049079141886945214715827908157233969124039985869390855173079801955546128513408912061084012213617070570430060569246855916468834773320856891412679428448041384682813256929148160109786272696866867373917118931462269134894580427789899608144709524762905019260311649206867743318661546966896601822663578788750608856243562678932797354633904182108774638039216244772025672699596391824687788455497179038515839204748319903127622437066235092518775434140107112335865907748122063763459019884225472727655290504399502524440391136582670813300580588209460310208261341369127572936992893029961730892843670315238589753987388936807441526373794240506448764171768613552343269865728970463069180174277972173889859443284852057257588337563820150546720651674252681894851673328046307647813293132602893229366045210213189812987661526244487486693890406178469916665417485084597970146178215845014919572109825089234517474512254327386819725864944588083771398685065984085457731654169174067052111949166286337732263753475666370022120327524389997736006074042702972203634778048298834855189525079474605519940340110771169725644261005092059843362535847069597185762616776630211747878341975644501838041029203240408826617344339090263522350506828582854432839618480925376130820115626869907999117084755586982150310073563240421988569584200682439926953784403202222374628147659230605547476936830576549677690471159625502474507809624837449908025613750915622359081010534493941774294277091445166668700415228544638076615351141556487854936011387473103828773313388391709646174829063156788065182761765798535021665998607464012674884121130098549938337106031962506702797524310119377335548537011694674858888363080333287739571656275340367272180705622562326374148833499289970258977299224036941750743427314194157432466794578586039894075097356363688815672159676354380665593938934382075984061216064317664421902677773799145579945031468708716266226524133590569928494006372744908821635242948022566330458553636337251762049074624062938962390622030424872688432377631733574205753997574373508409657792180880089420590662572782307692788656445563758012667280952527379828030076636976928164844651277473822397061738567507146692748220374881122563994075227626464994658463674019559973702838393119884822335539964978333165008467491254522956512409390963784095416901234675375280139080830863022653352387069273071984654649454979101134287154636695543437462154391886526085366974366530588562164411648068912837357794341530609478457270987037976921346205969538843826760827659181773627669918727803754219954172428335791064520613736884708545165822193158645377018313401818827251099922917614711860529176551422881123566217241692680620648845317615164272953585798375412375876100415475805595730122459276711895277333823356043374201321392804317053379463646428351993014576706491847707768959885421647973371769625943938648074893633201098893643528324494132569317438323509258286421276209473432879984387198291625035886368857440896091619767553023636147840186271827708891360398933077293060296717760258418030133475474406093218222662077059842476082637941388598601935208959821941885723823714271930349354518240112671046073097412681279072726438685681544729144826761389945092064098792647692574698812334642995267308237405720406143748700867048612599590178424976845844736824827947824753176338174814799571031203396345226743415123722322454626546328353564246627786460839872179127843089641636422237152822199860850600158245169478318926060165827491142774933502865503727691068107557826463340399219222602208590967841860013859653877265826244657597694069240541804444738471607901449743018055889337623761296918229234768453759556468421122698731637506249971182291485689604472527760093934343558339195165132985623645893149101860849683480338090932736261062054795970421298669883573560404347128399801249802209466851093490407878450102117684276345079137687609746900665759683043519266676563960922648845670212850744821184836102907689196493402300641753173483914758916672023069245347107627719792524997328576890388680141780313799483651089527220946591304506656658258539174690486872649902546765966599164547365134259755577397348506528439977384490513905829430130008366961455669748537793407881277215791487210719258869089277878732982982214574233273265987982756950898845306240223036486347722967056524127035887830281940074980575439016285786745531327197652607107643153112391526077219362144346096089758726934223674331613718574577608117751518069662104795585140130069701845007026290479492570837120175279378554957627391245587148332010170361840521636818017341425089806160634676330850504184585816629334093479199103685913053789482158651701181210113330006695775232786685518078256752836149494920745837336845813691407977595925267273966423478746614399819648081036705066005238269165055144634711116867428177319502560642951637959659475644987891461446925936629309364804816174059808214254340525211371332408113913579971622858101419103410460569290782498956214560041045692221416830893236662517618696271719453854998551484275173369241202680159928083201458300754484742331264387808478085056104304909999364345905195187494843696772757473359670883349609157447435750398602016397666114276536952670441155200193914842934601015129531174458876483070371677396154265591399083037577663021309908712719887069032930470124105861506399852998141757804303480803588203202011047607004755710169423412034108915643947825303164593730437558194686752534953230130276782353560116641311177996099793662043449569683547930754311327558643189731515171064432189249793277801264964764475467078165807406131259375271847408816115479818307816751047809291413954564631160581269051753953556915775580410671981231638405277556052272223764711883233223099585068971018717504781906533494858423259762256575841898529144717833517322602985786292943465056366932162627673816245957417932698892327220666636081992490988831468529940991386734446049670842442978243630232938910355965601739942201988690257245471401633009612146187208365108688185334060622017099515827070442337042180176696349133695996064322005328873494893135966030424380804565944743335678316727037296363675942169993795216709569239605768464124347542886216245149157793040476753348053033153307521541526385710525422090937728732169921993755078088729411025976039372079494630773816321627677758231545511712133606496443134498613014698318686111929868996577503784519451854724162206976130886307000710449638898858341033555502859580220113658542705557765562668931284762149536288307592916507067735066925352644695336056301100688585609305533142306464911577431203418266408784648989833436453569414451359565299946353194873235833654149912091860340699657865139372140627836385084775887199350057479097575575821175405351435523866639331618523705204967991251182676180080717649555661886440043165185901961567355270606851436442192137316100204985388311981864969315190493719216273102798831337759268776002675993022444055363142019164277411901370175415170402452994379515292362166695619231382936999237019398531726989373859914221290389848610849267471382592106802650550676862778123345733959989844690818355080097898838050307572662908675028309257586145638783656294981053573592917496461623137707802996548502550264310977934737337524379483252699651218500997055530858400309861246730432929767608197353492136895008495286646640838728286016708683549765123021169308056436872386411643645448955160189710984522491878379890966570195078344359051912278712755757733414151965739899834250985394949988141243867834464873827376170542306270476547318264631092291393359618691179772831791867789266428054498091940593562998414835665844886741681797338164265740108940859491300072021588718078252254566398621813980490305216416264740583335375040007401944822542799937106484915540517805980677612154774199779863715955202827504416259521370231996415590408422945370845053182339069574228180267420934592943172176664705528067554152692935177725126373997210446455205841575750464849453827350764901238368245042240627692293459944117496893475532632823427014968216980654553172552398001772054307127018595684369569896821609274381477524861268071826303308720453858655587689811222175453630040489748768999958305726483427590138858476503981930580029789904414320737977684158031959270878986203686850567428253092616139905181459089956386311375579715072615294130317445492402147964746006967031278643019018820326716298212114252367320903055760369513934774922721962527524190979265435827058619143826236169596554570620436214536914822593105671368762112020418219967004586305486471435319876530196330777690285679543242031748695423978897102466863258735101760481858925973866441814562327799457300954367413841317476805534437990136455326858247674930722202900176242045728990633288539907851099363098353777693682699124705280123778232411442696591393016391555798526705894127926299499436463694470124952235021746832175888475755348746313185164231799127100671136990144220424064070263374666063079096224489100129522953604036686289554466354237554841828524675610324706812483024928725253862445798579719593410540608705628706044299291933374984302929767568868612774974045445966764907689233866190175323317470499841583977555955451466511472508792000876600354880200354341610020305183536055028738150423024888224201947289340717085805566897943195571575730871119751374639571086211214874072275776032636482665098692074832278093537135164020890698676221406470136823982545108075317711863228682727633783528212174155204433402435700820641554371716349645643195200892645976028414305198296988235695119621048155662297295589421312543515213365886532922224290456208850741610776952764618857286629967391241027920346745904411550242722281550897848925808723123074856341281625659723015778555980028113681066356892739709682211691075159919634387328632629201508717133440668793907974147464307979333080873035698719317899381257885830615761983975641743625647621763309874170588059999652801469172287371518094117880206138274965442896592604996471821958296214671212080939644348004070447124162488767823158200105878565032378099290417553718057489140300242884391770346048989829471082770577892817470121245176253190918409307162964622812236802973323666124435869331175169666347680294629208522034563496792889670439307806791537848750850066089974053287840422088610933543981332125812323083611244408211512816512732499175306407958978872018917220734679395032969131268824194215802460569242870178218489689038094097461603250984979561010673833099080031030610623273280719103933857898803653226331288587588493359764699655904785345917976519080139726545812480950502874279621264289206096715928928596662751911845516371261980516927830644753500367390898138711962711507442635682622434301099632308185211282094860540532706943313655028782325012426696091909913326994373707341321077502051446264702381406223012585495214299304768475022588429094465242471206017272772932505883443651104529738473935942072626852387931086829030809655595590134562395542392852379311884025935005253481534222953347803554559778610086985318133062573910363923537390428356586131351283884522733674984196822550243685114937855272452177655956877624099053026256134408103683695435680852395523052628815095052507171773415550313877639119316720661902999244435131761416014843172628442837738319446899863061749834282402161930271425770576768541237158716334527693451990427356693545040375254639050787477825025408285191161819606119006659792959080766107210732529588732418057039430458592909920364514194752283577743102434837076492814142717099190128094188185144575359600878748052621212289966216277729848620201718774883691046302905667411677038849683178663211535119560453439860540202932233471619702890985446017052830982478177434296395989471138710305617435238267320650123792262353793696725252438626128226858048556769046513841492021753359156153240673679682599281376318084871440477118608697819703027671908010427058033918425787150417682388147490773175287953555058238774984179040090396562488354393310516827264160271674603139440215805186047972510074232810448465132126640074148806984200355166266846933269740692202640373506831721298994362375926499655227680229389812003725734159634256354158741219975987773579751423646751659964273643626108410171855266867978017425340041413187665416284844621550331942326302128117480852834127160417563426297896186359214732873873672694203634052596734138811832703362713913014107777287016256407669394276622830711711846242982728723021470267633538891167017193105043928258310537830524953904031758742939935394060558147511014286932645500797977023089784096414561911257188068645805256159634380324878116399174282037733688479355234881707888370098132337842673385415646164450171390384335952382039527899069566158301776853193821776129633949579923032979482333075571171457733545429404818067652516223171252457438333367744887838869525767143577591055712194136166155408115021128930500154964397564959583716953040005798235925948481313394223107417643490492590439641988997339959250424052794418453135072420266145400256336790234518361886727697290529885440012309435209845278594333382772208025665227845382614199424900507497393470549069398624053307361720832480251672370005674945925863234852428631673708949656027554570443573407126287237246101565716669486628658233896757493447439056857711282562329844093126286339122564725522333620075830814575611475823947498904444603437982518749703249992081428801157378733772198329275743967801910329116475707903909190179844972963905018286179464372109227030337865606750951106786967420881963441994477648892305324369902046628754616797189374920853292157425000612844800774281587438224317401256447668064171875578517823939138551137344891967236829604273661848321020560659365531063540786458106098743397747314075207840656074324904192163038905312801677704588892990100305442484436567019705245264494523894846061602983157114716045079637049737235748838903287650997996653079191515260766101054634682095026518084184832296266527566193128529460498572374403753167457479414212458293039825006443051575772694917463184109010110962502699903664495440542542142938680559710636467586597514545149935085838170298550606565446562801932139705607568436638967812376807725917423191981470059170449292503170689359987610414971973366352728956501902486157955877439693068990642135651712352823034393312962930161809449424946446233634380764077610280247359325555626601150583490532390819457101781766030810321811084123280098016925436129123628568957535372708515049092313886050683485068187358324479470998838807898590224860402145961136838870016113879350377902827296030054648848968218816327779571067879941099752187115374835211690427013397473702935492108934272861609111274876564778631805825694593498506846804861892691431054019085740014621362634150765122632827059656235013343217457295763251029599466058738619139364920829082521338319912630744635281639360107412906940282230041456107706969125262522452367118800665454226798725068780012622076276164680448052578166659658281787946299088442478823249893385489827514294910419807127863660338552431521603503343280724688204216987891259949287235557145251913128912791488337376465833611234704691419472266538783225937801735894318812009320716444160966358764419135650391210031949190047303195954997009584549393427933945472129273040919897442592158932547139439405295041503895371690130699203969186419522146031577542587690433389856191841420400909836237674679435519286180057627929713441938887903287428188691702246112912096332097497844927767959792704367247345324941138632648231213795395510725925266335319311225031798504735643123236320981602844284985810268768588725781436344140821764710208660069720624136259192674078302148890659103690163364388337285619905484223708596439346341462078222737288453241827483311859770008935494572941950257539156303030028696344894170412527024696127881501205781079718807182758357425794659574284324219790366939726434624042436536310729307714880389288034900303968358879602079891169858149535750079336470125533784262795624716453188038049282759266531180520722668865165588300942936672088325514751047647968479508577883323259681466046399702436699361100613130372497968310621980172277534267485537501140974263922020611802237883594776239188331516109960685515626250611706307922135017901278948349061096832015064692015979205858544340710577726839217845466619801058661646388594466066010764068276437055508206680876329704235849419982144493427454351579420323047670055154794306655993846075177548371277261263525013526247936756745214256645715613073641178194923159923439317388913320647445830149666834224735570506646644303656829076940602600980731503149510619229408674290686255310965727134097568786381333909635949541068903216344621529530400333220491469555961386240368505710908567419591401103664442306531473714057834553739945114867429015804932561301781807974334992811476831893198719549461034105963839610590279089070176242868766784840192269051267101607132870548559355260824521582896921886239985724317241470684480555586554087550113511264600148337069031253281262782854556298781956836384649569365784926399799357951602119435681186450907182504837804921127685751737260383991985187499661987389617246650068471969158883496399488776091656579823201353284993378766190452167766815657421570491775771087861458712080174545650491865100128202643872090015892438188447028140383940206437604450294408420374703108656622696626225539817801824554258186980391397312291173730380444881810364655536871367469097571803137889443280415757167110920467710626431568108399368876966637168009583921696865086973625722852980039565450822764832970381652851098568973976092719100844826713892754235524698742520417075622136751488305153495432164191810248230421938562037006064266984131204995677156433875274315552349364656155903287434976705523947041792961486984692325225711225766397017648662037828260863649917460300179837100454169980511457151376235960239789180907045151135973637650058946986170621152886390290358544208334672178465345352125819989962646744789035794528810579298385673391577266233824937633701990541303637614902688375797233832665213568264484725173110897226617534812008937174010904323064619498661152000335852953264242272212556145543648403899575270456109347342395333284286853933563144676244340656679429983698649711556925280395696757385406288269050581187788585034004537435848006794583908053356265417048502153432986985676834320577489603367137700317737076416019099567915397351663563644314866397901677715953717137699610608457523281237229752928863616532479872590250875158826042510398222252473630015503172974755629131502027578916939223701302499900684123489130293422838284520880638258302570993296142257714690583138179889582652860632352163484076305505843814265954861350982431057373669854000423931062316436742194941691614153265513366042949681928957483325878286630090847642404611487341191544291528775182711970250721769651552726799671666201910109126290476869540096230031405243679322073773821693491315671740797971673810326678869521552590609756378588225156863137116616771095165137325986628075919164590863022524487853881691455772837493407733998332370626698022069400952958611694325174161870610170771915127938031138248720625369017303121324557205065788942661043037752903124818561226901668632437558274897419586865208082394387966881747010831834948853751141792119059218986604945494551683728746750702786785852527334919711299718819308976870836294562412797694892556445784044459237809666563218062766468460212092243096178908163522262130175652095896204932600825473314440746089182103644044859323897240345256964094037683325518778965861024212825138640045018837189108711263540582161807695907829843194165998789707719807731025125024720524764755437880423172056979449817642897280109584960489695517650388029094798249408906199363509093687002477652275738684926502545879949807069508410018931336069491214081956091852396282152536922363336740747470509093665815859201338104121972848609181543115646490998044950795802696404815870919621337351728543419464745333588615288649309067279219429243747392619652834957455991121605023828401240208039989008958218170985076691349132772464741737455580393098691944813127133165142369260089219637587207491461233479513452954327056624164749914333383830716381991325338835188598381348123815310147025626607034269112670574399411057212403736296135701696592299969344569882509688943338678898310910298721753358070915655662953964347403734070871523221578475113178877733397100066561506252647745933136136404608723326298028805443184691324448800777515756256421330973570355830617113976107855074982560675782292146134712503690051521412099467028539444567098593466259506770393912742360382753414880141371910933800001994789406893174247900465740860007483623379105616188482931266222856540297966587648043206200507462841806041638339612637386952136205886976583883993845276947394954200303848968626987018120723592296245816501503714951544369794102437270332756733967105494991111670926786387044532976891261430008782102222165130346640617667820814935234173033505638249928578849223862197708095731168340127166622676294983622799854679994122519585289891834565568999083686692898903953575955931683738650384447666338096609558073702302879548223358626445124857002222198307859722009039136790832201130572531097459937812330650230739198677560540579574945504521176355621872940957048461262734344519248986182545908965139047387787586348450227742284036469619159161953944619720661882981215670502337803726168552584073710543905818996284066689549493362216580473071682773848496256692190105776270831686338301781819142469561842951983248991478897129605148467180929825585216703079555698902614336997406953974255281459507117959340037752354428642942429045487498121883221753423215794327147128648857349591891960709866672619731082824490322683003962622171447010710375347196903133874064876906668406418526929440539470715303267867504460104875902385004773652100350451391994246232998166231781509121101522452464436376794668535192319654182336068931156362457968314874087131778308402948058752467775324795093600413075739261285694181241478829683233569621417998764582671036131228658578615465385482971852864777607136916846190911552606026597855064813896626205197005631051042885521797544795505320148203814303804547529245934671501906821021724904456987016210209980706405622955297001899392886204710789439425469146352468998922990143098360734414432397334828446781546509755531397110067715238096184865130588015958658212957908577485452364993795616923273112090640024130684569170894882950807927493497027995479017670780600601740515558729791262775471568346731305829047228105567275135847834742736139096014498404517512432016643389818328017257561626571932639700788393999676060990609803267526928803220482775084280390791450386951321857461171061677954409071031858935851765861632009325050449815236051663587192359115917528622839139326741244468955900585792285396851127360476248656509819568543553722258336595764030082587676080327691087674812495312784981148755547078046590247610173078522416891717432338033857665552604951046648667974251843986571356514757368844974489198937241159033188370119958551236942389068129198884215037034833951696570167417270942820166998163884390955230276003568201695908776398830427560132353769559200657813954672617319003033215053340684672575416932319121430795421740797048756678884876591195321078312665330817459704546371803386131660689140511227147092123045043967011768793066841193006682970785300001805276517658874678275846984114631016639559964946965821085460499844687510145859578132649723537666991712324429016148657819799352719964674168875842490259539674131139209688215967932967432852826656471791065739966855771711789901186883329517562022835732249426803657581706241225748956424421318666103846265421820025662228985907860372190570323215018899286459672123041586536481071535539000184645608406493724141538945431986305765687643374391218490903553662105863514761975056203816881435224481990124829205994973426032758380390912540399159930947430603486664048528017634801313917668548100694297763534606980869131972157910878703411044367821419523217098751306085546437485024113400992987197857899862416024209288086133411632455004459619696052373090316460013039800940467427605908339070863602331394899334966708568980546857717372445995406902450694832448864481086123781500485239336436644723635377633067983753762187906914968513379403372876842464420090857355027311367080320459544764620966648798588088569909263239068212111652699697283725847815064879823984396569075193011433972230811530469277567070102210167971339935194645657118930874203854356237828052215594963996640314523227580578188566019450020024022883575823698143584629290025253079151549578335611969279387985272545260782148988358730067200834516077811002701989857940532122600909131312325925247336660395108922399836508309484004563892539961790613018061272962518723984178327204050158803234886935878163614859555216415835548685132917227236051063148770879701410194096811051365011691095868372083468082022531881964370624077758547899756463929222302388743240028828127383577619344235178889042034385113709971389335112177381670303168651330470906164183316989820031853057271850105090600296142729408545823281973764245505035274677327406888374108312676849346413923165994210569619485010006629529696272525161445552348350493893381774317553312461939982820869523261480333875328140526423164269924161411408016206283240128846284935534262357630666762972048658761825646222389613558539496082914389177182808443248725230130236668965343878018600360150171649546616087980508155520705129615146270706160124129368417109806278413706772301987968049306800222895907339225526481666399635937641136101551826295817064587277380053822895046407615006334957933550403718553044621161959436128107263461473510839767493348292385068599807037838025308001242086681750199900579562360880008475837829225903510942600593462002825134181524391556805343177145972883250925747615178329297793410342627550328268266513044740176754430872348722865767748980695061159746749879585575818838755558433316821039560065702352035190963002663764779517773071120627195166684631875791300039184796104376414994599597212660860012818584760278706112995199618926904506781219283677274360602249713514199521465737589561703501552822099687754921097942957860951165885859146130994277294392886118714170063093918550921620669063816363371226584819297066129101912009117963828443577937663231695823540864261006812590709702328668499363607754431461433645146639200100449398720913805292282981480243291527099485349936799844687369525832594596061999897846215370058097868444181482571733187303892518281285088829947100699277580733502300150322434942691935892241680486090430784448182794421062603898061054807344139852587410061019043731899400576904324297210493591407877071935212749446577744901052633819042748440971733116341726625524931517108619481864764131542733382230021050412134614828898421403936951155383046343591635832079497360324671531871790188361183474513740450164064203039608908460740099434431307697110650146420024010063431245404207888790391693017340002966710403608907472402538418115072994314958320223564909364084473328356635122335508268301235778780059149101095164014383162168890140763961781667614392295545794687203573968969683961310268724756295175874698266078652415044873043039961616463718029408708255486445499483405649632209103170916008947511188553063235477719719358846498855442696062893505246880013178626279995053377788311304322183943819703616929462346597465222479073401587272547712889255810748299426788706934257404778586574951722474369177797620894291725243683044676600542992454995510524864590955073270242813098889173862442301358041714571168681020693008432137864120882165250856384468202835426079622378104879306160962120900546139277662841273477623132835482172184141905744845181939751054487868198984407496548919098559471969601851758222968887541633347522408378789735773047908577447455612832821602155405827403413161537703062586834998055239041053409033738811097892658493252502816403962513760725633770146069167066532792804227640407793063244111032775696374294484490686818127257488752515929507723255805228951744072483441250997124044245002972241560389945556322416985246776479354588171146372494569645044664389731609845920532205528035042708713870365854532839860009701966815075588650203010222535040361547144307212036939817837395932005593384478099755206914052673265945310464643034539117170528062001382347585137236739411351633235133639414731121721897017894355903863378245820238085197854093837413899482506971560070581869717180488877187305565082199032657991670991375994715548887249049710488091233361596815086654533040897420918972630387979224917195931114681723497697060923389909780265009991656396813591561241167631050181066706074330026215993795136138087227630190138008467497974045326808087116989449828401641550417943378806215167122246384418339274360101226239888614315631640448778569771022755813543242162896665610766537527581122529967858804837843022491722938307559320162340428965920902597501754992326005980149983319280347655975453018792298336082007716307282505275653545578764793060152715159714058331188087203708668056251292305821109172362558488623845891426568076301434954074171517094515892875501695499111840858178229638258010945989540593570094411084063836105458984480043361447062204121053667779781031871209955187841489773469030701494082781643386447987813541928619686560273783351063011495218872477399881442580697720115350360670454497087331991751276747862257512673009834212856975144464400164670719735957723782880028443376649462827806920205928717790754417643349585668123022523683523956609982420767496043227874931810868704880862669249208573923338637614572568695058385974238082935007777350196507173178624443083034379426695131525299861771230396635786393540471239548256712106064485043450762554932488938909032885723540491416759238405957726792202222426334233767555789836316498369396754336479164137489982528729586195359402289266842574275563299728756389707218806777718559959407109028331597378952008787804003656090889867357802861255136036093310424595504144713773464998868544306774262547413990576404184256730735302705795280749855601356089667937425593827736770170883572239008649973041789662616357832225210578257649273739013985013061468168849339312697514100690262033749817867146058598177547428269968309142403958731250168331862961789723822019555503669132671576404928132510283142659583884581706466370843833790284331977185716531490046056470772764986588556555768286522900629386233120247044829976595281900134103219830584999889551861024304761859828979714523322140424299670549403824315205662779874087644156378985822912837278089808934231141976491894603256710914810802226120475657834278037000873143141963486671452722527039769205262274203426581043884495414501633916045920828107512246773473421931989638336413373390377527314999479702122485635854958920294034194178363986068599912714827099719060614751206329526056584307987519858607260899868297608738956007721938884007057775201407943395440100133039027602706916018240425534743865422358849355391881492792266635344554037388205070311199820212782896950964324617745039301384679582379166776660002711876725811989610297886973857047422968098645009043506835883520129038241548742806327037195310231316951437031830207973653212270132062296130332956164946204275360086143034956743430054922822565268407326636888702703347777179944033328576254784971778353979267371144998163339726174014723178325100889932000687150760857757536565656128387642016524913435354028192802514127693003374858178765937801609843662827855002935170401596040567581050304583919773611513930972873970201276524751450151031955317409444619072692633261636665074996040178375438691524973147576183626839083375051101503462344828068198390277441389160304480458017821183778939320922603271351908911928244613374097862142853211600055588341975888889031248819067909709332809915398960728115270295753536259810005325
FRAME_INTERVAL = FPS/math.pi*2*6
FRAME_INTERVAL2 =  FPS/(math.sqrt(2)*2)*6*4
BUFFER_OVERLAP = AUDIO_BUFFER_SIZE
start = True
thread_running = True
BIT_DEPTH = 16

# Add these lines at the beginning of the script
pygame.mixer.init()
pygame.mixer.set_num_channels(2)
# Define global variables
current_buffer = bytes()
current_buffer_lock = threading.Lock()

def generate_next_buffer(globs):
    num_samples = int(FRAME_INTERVAL * SAMPLE_RATE)
    next_signal = np.zeros((0, NUM_CHANNELS), dtype=np.float32)

    for glob in globs:
        # Calculate pan value based on the x-coordinate
        pan = glob.x / WIDTH

        # Calculate the note index based on the y-coordinate
        note_index = int(36 * (HEIGHT - glob.y) / HEIGHT)

        # Calculate the frequency of the note
        frequency = BASE_FREQ * SEMITONE_RATIO ** (PENTATONIC_SCALE[note_index % len(PENTATONIC_SCALE)])

        # Calculate the detuning based on the glob size
        detuning = -50 * (glob.radius - MIN_RADIUS) / (MAX_RADIUS - MIN_RADIUS)
        if detuning > 0:
            detuning = -50 + detuning
        frequency *= 2 ** (detuning / 1200)

        # Calculate the amplitude based on the z-coordinate
        amplitude = AMPLITUDE * (1 - glob.z / DEPTH)

        # Generate a sine wave for this glob
        sine_wave = generate_triangle_wave(num_samples, frequency, amplitude)

        # Pan the sine wave
        left_channel_gain = 1 - pan
        right_channel_gain = pan
        panned_wave = np.array([left_channel_gain * sine_wave, right_channel_gain * sine_wave]).T

        # Crossfade between notes if necessary
        if glob.note_index != note_index:
            glob.note_index = note_index
            crossfade_duration = round(SAMPLE_RATE * 1/8)
            panned_wave = crossfade(glob.prev_wave[-crossfade_duration:], panned_wave, crossfade_duration)

        # Update the glob's previous wave
        glob.prev_wave = panned_wave

        # Add the panned wave to the mix
        next_signal = np.concatenate([next_signal, panned_wave])

    # Normalize the signal and apply amplification
    max_value = np.max(np.abs(next_signal))
    if max_value > 0:
        next_signal = (next_signal / max_value) * AMPLITUDE
    else:
        next_signal = np.zeros((0, NUM_CHANNELS), dtype=np.float32)

    fade_in_samples = round(SAMPLE_RATE * 1/8)  # ms fade in
    fade_out_samples = round(SAMPLE_RATE * 1/8)  # ms fade out
    next_signal = apply_fade(next_signal, fade_in_samples, fade_out_samples)

    next_signal_bytes = next_signal.astype(np.int16).tobytes()

    # Ensure the buffer size is a multiple of bytes-per-sample and the number of channels
    buffer_size = len(next_signal_bytes)
    remainder = buffer_size % (NUM_CHANNELS * 2)  # 2 bytes per sample for int16

    if remainder != 0:
        padding_size = NUM_CHANNELS * 2 - remainder
        next_signal_bytes = np.concatenate((next_signal_bytes, np.zeros((padding_size, 2), dtype=np.int8)))

    return next_signal_bytes

def amplify_audio(audio, factor):
    return np.clip(audio * factor, -32768, 32767).astype(np.int16)

def generate_next_buffer_thread(globs):
    global current_buffer
    next_buffer = generate_next_buffer(globs)
    current_buffer_lock.acquire()
    current_buffer = next_buffer
    current_buffer_lock.release()

def apply_fade(signal, fade_in_samples, fade_out_samples):
    num_samples = len(signal)
    if num_samples < fade_in_samples + fade_out_samples:
        raise ValueError("Signal length is shorter than the total fade in and fade out duration")

    for i in range(fade_in_samples):
        gain = i / fade_in_samples
        signal[i] *= gain

    for i in range(num_samples - fade_out_samples, num_samples):
        gain = (num_samples - i) / fade_out_samples
        signal[i] *= gain

    return signal

def process_buffer(buffer, prev_buffer):
    buffer_mono = np.mean(buffer, axis=1)
    prev_buffer_mono = np.mean(prev_buffer, axis=1)
    crossfaded_data = crossfade(prev_buffer[-BUFFER_OVERLAP:], buffer_mono[:BUFFER_OVERLAP], BUFFER_OVERLAP // 3)
    crossfaded_data_mono = np.mean(crossfaded_data, axis=1)

    # Convert mono crossfaded data to stereo
    crossfaded_data_stereo = np.column_stack((crossfaded_data, np.repeat(crossfaded_data_mono[:, np.newaxis], 2, axis=1)))

    # Resize crossfaded_data_stereo if necessary
    if crossfaded_data_stereo.shape[0] != buffer.shape[0]:
        crossfaded_data_stereo = resize_array(crossfaded_data_stereo, buffer.shape)

    buffer_stereo = np.column_stack((buffer, np.repeat(buffer_mono[:, np.newaxis], 2, axis=1)))
    prev_buffer_stereo = np.column_stack((prev_buffer, np.repeat(prev_buffer_mono[:, np.newaxis], 2, axis=1)))
    buffer_mono_sq = np.mean(buffer_stereo, axis=1)
    prev_buffer_mono_sq = np.mean(prev_buffer_stereo, axis=1)
    crossfaded_data_stereo_sq = np.mean(crossfaded_data_stereo, axis=1)
    buffer_stereo_sq = np.column_stack((buffer_stereo, np.repeat(buffer_mono_sq[:, np.newaxis], 2, axis=1)))
    prev_buffer_stereo_sq = np.column_stack((prev_buffer_stereo, np.repeat(prev_buffer_mono_sq[:, np.newaxis], 2, axis=1)))
    crossfaded_data_stereo_sq = np.column_stack((crossfaded_data_stereo, np.repeat(crossfaded_data_stereo_sq[:, np.newaxis], 2, axis=1)))
    buffer_mono_sq = np.mean(buffer_stereo_sq, axis=1)
    prev_buffer_mono_sq = np.mean(prev_buffer_stereo_sq, axis=1)
    crossfaded_data_stereo_sq = np.mean(crossfaded_data_stereo_sq, axis=1)
    crossfaded_data_stereo_sq = np.clip(crossfaded_data_stereo_sq, -1, 1)

    return buffer_mono_sq, prev_buffer_mono_sq, crossfaded_data_stereo_sq

def resize_array(array, new_shape):
    """
    Resizes a numpy array to a new shape using bilinear scaling algorithm.
    """
    if array.ndim != 2:
        raise ValueError("Input array must be 2-dimensional")
    if len(new_shape) != 2:
        raise ValueError("New shape must be a tuple of length 2")
    if not isinstance(new_shape[0], int) or not isinstance(new_shape[1], int):
        raise ValueError("New shape dimensions must be integers")

    if array.shape[0] == new_shape[0] and array.shape[1] == new_shape[1]:
        return array.copy()

    if array.shape[0] == 1 and new_shape[0] != 1:
        array = np.repeat(array, new_shape[0], axis=0)
    if array.shape[1] == 1 and new_shape[1] != 1:
        array = np.repeat(array, new_shape[1], axis=1)

    x_ratio = float(array.shape[1]) / new_shape[1]
    y_ratio = float(array.shape[0]) / new_shape[0]

    if array.ndim == 2:
        output_array = np.zeros(new_shape, dtype=array.dtype)
    else:
        output_array = np.zeros((new_shape[0], new_shape[1], array.shape[2]), dtype=array.dtype)

    for y in range(new_shape[0]):
        y_floor = int(np.floor(y * y_ratio))
        y_ceil = min(int(np.ceil(y * y_ratio)), array.shape[0]-1)
        y_offset = (y * y_ratio) - y_floor
        for x in range(new_shape[1]):
            x_floor = int(np.floor(x * x_ratio))
            x_ceil = min(int(np.ceil(x * x_ratio)), array.shape[1]-1)
            x_offset = (x * x_ratio) - x_floor
            y1_x1 = array[y_floor, x_floor]
            y1_x2 = array[y_floor, x_ceil] if x_ceil < array.shape[1] else y1_x1
            y2_x1 = array[y_ceil, x_floor] if y_ceil < array.shape[0] else y1_x1
            y2_x2 = array[y_ceil, x_ceil] if x_ceil < array.shape[1] and y_ceil < array.shape[0] else y1_x1
            if array.ndim == 2:
                output_array[y, x] = round((1 - y_offset) * ((1 - x_offset) * y1_x1 + x_offset * y1_x2) +
                                            y_offset * ((1 - x_offset) * y2_x1 + x_offset * y2_x2))
            else:
                output_array[y, x] = [round((1 - y_offset) * ((1 - x_offset) * y1_x1[c] + x_offset * y1_x2[c]) +
                                            y_offset * ((1 - x_offset) * y2_x1[c] + x_offset * y2_x2[c]))
                                      for c in range(array.shape[2])]
    return output_array

def play_buffer(channel, buffer, prev_buffer):
    if channel.get_queue() is None:
        sound = pygame.mixer.Sound(buffer)
        channel.queue(sound)
        return buffer
    else:
        return prev_buffer



def play_audio(globs, buffer1, buffer2, buffer3, thread_running, FRAME_INTERVAL):
    prev_buffer = np.zeros((AUDIO_BUFFER_SIZE * NUM_CHANNELS,), dtype=np.float64)

    while thread_running:
        channel_group1 = pygame.mixer.find_channel()
        channel_group2 = pygame.mixer.find_channel()
        channel_group3 = pygame.mixer.find_channel()

        prev_buffer = play_buffer(channel_group1, buffer1, prev_buffer)
        prev_buffer = play_buffer(channel_group2, buffer2, prev_buffer)
        prev_buffer = play_buffer(channel_group3, buffer3, prev_buffer)

        new_buffer = generate_next_buffer(globs)
        buffer1, buffer2, buffer3 = buffer2, buffer3, new_buffer
        pygame.time.wait(int(1000 * FRAME_INTERVAL))

def play_audio_second_interval(globs, buffer1, buffer2, buffer3, thread_running):
    play_audio(globs, buffer1, buffer2, buffer3, thread_running, FRAME_INTERVAL)

def brachistochrone_curve(t, total_time):
    def f(cycloid_param):
        return cycloid_param - total_time * (1 - np.sin(cycloid_param)) / 2

    cycloid_param = opt.newton(f, 1)
    return (1 - np.cos(t * cycloid_param / total_time)) / 2

def crossfade(buffer1, buffer2, fade_duration):
    fade_duration = min(fade_duration, len(buffer1), len(buffer2))
    t = np.linspace(0, fade_duration, fade_duration)
    fade_out = 1 - brachistochrone_curve(t, fade_duration)
    fade_in = brachistochrone_curve(t, fade_duration)

    # Convert mono buffers to stereo
    if len(buffer1.shape) == 1:
        buffer1 = np.stack((buffer1, buffer1), axis=1)
    if len(buffer2.shape) == 1:
        buffer2 = np.stack((buffer2, buffer2), axis=1)

    faded_buffer1 = buffer1[-fade_duration:] * fade_out[:, np.newaxis]
    faded_buffer2 = buffer2[:fade_duration] * fade_in.reshape(-1, 1)

    # Compress the longer buffer to the size of the shorter buffer
    if faded_buffer1.shape[0] != faded_buffer2.shape[0]:
        if faded_buffer1.shape[0] > faded_buffer2.shape[0]:
            faded_buffer1 = faded_buffer1[:faded_buffer2.shape[0], :]
        else:
            faded_buffer2 = faded_buffer2[:faded_buffer1.shape[0], :]

    return (faded_buffer1 + faded_buffer2)

#we're not really generating a triangle wave anymore, I'm just lazy, so I'm changing one function instead of 1 function and a billion name-calls
def generate_triangle_wave(num_samples, frequency, amplitude=1.0):
    """Generates a sine wave with the given frequency, amplitude, and sample rate."""
    t = np.linspace(0, num_samples / AUDIO_BUFFER_SIZE, num_samples, endpoint=False)
    triangle_wave = amplitude * np.sin(2 * np.pi * frequency * t)
    return triangle_wave

def generate_audio_signal(globs, VOLUME_SHRINK_FACTOR=0.85):
    VOLUME_SHRINK_FACTOR = 1
    num_samples = int(FRAME_INTERVAL * SAMPLE_RATE)
    signal = np.zeros((num_samples, 2), dtype=np.float32)

    for glob in globs:
        # Calculate pan value based on the x-coordinate
        pan = glob.x / WIDTH

        # Use the note_index attribute from the Glob object
        note_index = glob.note_index

        # Calculate the frequency of the note
        frequency = BASE_FREQ * SEMITONE_RATIO ** (PENTATONIC_SCALE[note_index % len(PENTATONIC_SCALE)])

        # Calculate the detuning based on the glob size
        detuning = -50 * (glob.radius - MIN_RADIUS) / (MAX_RADIUS - MIN_RADIUS)
        if detuning > 0:
            detuning = -50 + detuning
        frequency *= 2 ** (detuning / 1200)

        # Calculate the amplitude based on the z-coordinate
        amplitude = AMPLITUDE * (1 - glob.z / DEPTH)

        # Generate a triangle wave for this glob
        triangle_wave = generate_triangle_wave(num_samples, frequency, amplitude)

        # Pan the triangle wave
        left_channel_gain = 1 - pan
        right_channel_gain = pan
        panned_wave = np.array([left_channel_gain * triangle_wave, right_channel_gain * triangle_wave]).T

        # Crossfade between notes if necessary
        if glob.note_index != note_index:
            glob.note_index = note_index
            crossfade_duration = round(SAMPLE_RATE * 1/8)
            panned_wave = crossfade(glob.prev_wave[-crossfade_duration:], panned_wave, crossfade_duration)

        # Update the glob's previous wave
        glob.prev_wave = panned_wave

        # Add the panned wave to the signal
        signal += panned_wave

    # Normalize the signal and convert to int8
    max_value = np.max(np.abs(signal))
    if max_value > 0:
        signal /= max_value
    else:
        signal = np.zeros((num_samples, 2), dtype=np.float32)
    signal *= VOLUME_SHRINK_FACTOR
    signal_bytes = (signal * 127).astype(np.int8)

    return signal_bytes




def random_point_on_ellipsoid(a, b, c):
    while True:
        u = random.uniform(-1, 1)
        v = random.uniform(-1, 1)
        w = random.uniform(-1, 1)
        d = u**2/a**2 + v**2/b**2 + w**2/c**2

        if d <= 1:
            break

    x = (WIDTH / 2) + a * u
    y = (HEIGHT / 2) + b * v
    z = (DEPTH / 2) + c * w

    x = max(MIN_RADIUS, min(WIDTH - MIN_RADIUS, x))
    y = max(MIN_RADIUS, min(HEIGHT - MIN_RADIUS, y))
    z = max(MIN_RADIUS, min(DEPTH - MIN_RADIUS, z))

    return x, y, z

def color_difference(color1, color2):
    return sum(abs(color1[i] - color2[i]) for i in range(3))

def is_similar_color(color1, color2, threshold=32):
    return color_difference(color1, color2) < threshold

def calculate_mutation_range(globs):
    total_globs = len(globs)
    similar_color_count = 0

    for i in range(total_globs):
        for j in range(i+1, total_globs):
            if is_similar_color(globs[i].color, globs[j].color):
                similar_color_count += 1

    percentage_similar_color = similar_color_count / total_globs
    mutation_range = int(percentage_similar_color * 255)

    return mutation_range

def wild_color_mutation(parent_color, mutation_range):
    mutated_color = tuple(
        max(64, min(255, parent_color[i] + random.randint(-mutation_range, mutation_range)))
        for i in range(3)
    )
    return mutated_color

# Add a helper function to lerp between two values
def lerp(a, b, t):
    return a + (b - a) * t

class Glob:
    def __init__(self, x, y, z, radius, color, set_id=None, glob_sets=None):
        self.x = x
        self.y = y
        self.z = z
        self.radius = radius
        self.color = color
        self.glob_sets = glob_sets if glob_sets is not None else {}  # set default value
        self.creation_time = pygame.time.get_ticks()
        self.milestone1 = self.color
        self.milestone2 = self._get_next_milestone(self.color)
        self.lerp_t = 0
        self.lerp_speed = 0.0084

        if set_id is None:
            set_id = str(uuid.uuid4())

        self.set_id = set_id

        if self.set_id not in self.glob_sets:
            self.glob_sets[self.set_id] = set()
        self.glob_sets[self.set_id].add(self)

        speed_multiplier = 28.88 / self.radius
        self.vx = (random.uniform(-1, 1) / speed_multiplier) / SPEED_DIVISOR
        self.vy = (random.uniform(-1, 1) / speed_multiplier) / SPEED_DIVISOR
        self.vz = (random.uniform(-1, 1) / speed_multiplier) / SPEED_DIVISOR

        if self.radius == MAX_RADIUS:
            self.num_globs = len(INITIAL_GLOBS)
        else:
            self.num_globs = round(self.radius / (MAX_RADIUS / INITIAL_GLOBS))

        self.split_prob = SPLIT_PROB
        # Calculate the note index based on the y-coordinate
        self.note_index = int(36 * (HEIGHT - self.y) / HEIGHT)

    def _get_next_milestone(self, current_color):
        next_color = []
        for channel in current_color:
            min_val = max(0, channel - 128)
            max_val = min(255, channel + (255 - channel))
            next_channel = random.randint(min_val, max_val)
            next_color.append(next_channel)
        return tuple(next_color)

    def split(self, globs):
        if len(globs) < MAX_NUMBER_GLOBS and random.random() < self.split_prob:
            new_globs = []
            num_new_globs = random.randint(round(2*((self.radius/MAX_RADIUS*0.5)+1)), round(5*((self.radius/MAX_RADIUS*0.5)+1)))
            for _ in range(num_new_globs):
                new_x = self.x + random.uniform(-self.radius, self.radius)
                new_y = self.y + random.uniform(-self.radius, self.radius)
                new_z = self.z + random.uniform(-self.radius, self.radius)
                new_radius = self.radius / num_new_globs

                # Use wild color mutation for offspring
                mutation_range = calculate_mutation_range(globs)
                new_color = wild_color_mutation(self.color, mutation_range)

                new_glob = Glob(new_x, new_y, new_z, new_radius, new_color, self.set_id, self.glob_sets)
                new_glob.split_prob = self.split_prob
                new_globs.append(new_glob)
            return new_globs
        else:

            return None

    def draw(self, screen, bg_color):
        scale_factor = get_scale_factor(self.z, DEPTH)

        x = self.x * scale_factor + (1 - scale_factor) * (WIDTH / 2)
        y = self.y * scale_factor + (1 - scale_factor) * (HEIGHT / 2)
        scaled_radius = int(self.radius * scale_factor)

        r = int(self.color[0] * scale_factor + bg_color[0] * (1 - scale_factor))
        g = int(self.color[1] * scale_factor + bg_color[1] * (1 - scale_factor))
        b = int(self.color[2] * scale_factor + bg_color[2] * (1 - scale_factor))
        fade_color = (r, g, b)

        # Ensure fade_color is a valid RGB tuple
        fade_color = tuple(max(0, min(c, 255)) for c in fade_color)

        pygame.draw.circle(screen, fade_color, (int(x), int(y)), scaled_radius)

    def update(self, globs, glob_sets):
        global TRANSFER
        removed = False
        # Move glob according to its speed
        self.x += self.vx
        self.y += self.vy
        self.z += self.vz

        # Apply boundary conditions
        self.x %= WIDTH
        self.y %= HEIGHT
        self.z %= DEPTH

        # Update color according to the current milestones
        if self.lerp_t < 1:
            self.color = tuple(int(lerp(self.milestone1[i], self.milestone2[i], self.lerp_t)) for i in range(3))
            self.lerp_t += self.lerp_speed
        else:
            self.milestone1 = self.milestone2
            self.milestone2 = self._get_next_milestone(self.color)
            self.lerp_t = 0

        # Move globs out of sibling set if they are far enough apart
        siblings = [g for g in self.glob_sets[self.set_id] if g != self]
        for sibling in siblings:
            distance = math.sqrt((self.x - sibling.x)**2 + (self.y - sibling.y)**2 + (self.z - sibling.z)**2)
            if distance > 2 * self.radius:
                self.glob_sets[self.set_id].remove(self)
                new_set_id = str(uuid.uuid4())
                self.set_id = new_set_id
                self.glob_sets[new_set_id] = {self}
                break

        # Handle glob collision and color blending
        for other in globs:
            if other != self:
                distance = math.sqrt((self.x - other.x)**2 + (self.y - other.y)**2 + (self.z - other.z)**2)
                if distance <= self.radius + other.radius:
                    if self.radius > other.radius:
                        larger, smaller = self, other
                    else:
                        larger, smaller = other, self

                    transfer_rate = TRANSFER  # Adjust this value to control the transfer rate
                    transferred_radius = smaller.radius * transfer_rate
                    larger.radius += transferred_radius
                    smaller.radius -= transferred_radius

                    # Color blending
                    larger_area = math.pi * larger.radius**2
                    smaller_area = math.pi * smaller.radius**2
                    total_area = larger_area + smaller_area
                    new_color = tuple(int((larger_area * larger.color[i] + smaller_area * smaller.color[i]) / total_area) for i in range(3))
                    larger.color = new_color

                    # Remove smaller glob if its radius becomes zero
                    if smaller.radius <= 0:
                        globs.remove(smaller)
                        if smaller.set_id in glob_sets and smaller in glob_sets[smaller.set_id]:
                            glob_sets[smaller.set_id].remove(smaller)
                            self.num_globs -= 1 # decrement the num_globs of the parent glob
                        removed = True
                        break

        # Check if the glob should split, outside the loop
        if self.radius > MAX_RADIUS:
            new_globs = self.split(globs)
            if new_globs:
                globs.extend(new_globs)
                if not removed and self in globs:
                    globs.remove(self)
                    self.num_globs -= 1 # decrement the num_globs of the parent glob

def attract_smaller_globs(globs, min_radius):
    force = 0.3/4.6
    for glob1 in globs:
        if glob1.radius < min_radius:
            nearest_larger_glob = None
            nearest_distance = float('inf')
            for glob2 in globs:
                if glob2.radius >= min_radius and glob2 != glob1:
                    distance = math.sqrt((glob1.x - glob2.x) ** 2 + (glob1.y - glob2.y) ** 2 + (glob1.z - glob2.z) ** 2)
                    if distance < nearest_distance:
                        nearest_larger_glob = glob2
                        nearest_distance = distance
            if nearest_larger_glob is not None:
                attraction_force = force * (min_radius / nearest_distance)
                dx = nearest_larger_glob.x - glob1.x
                dy = nearest_larger_glob.y - glob1.y
                dz = nearest_larger_glob.z - glob1.z
                norm = math.sqrt(dx**2 + dy**2 + dz**2)
                glob1.vx += dx / norm * attraction_force
                glob1.vy += dy / norm * attraction_force
                glob1.vz += dz / norm * attraction_force

def get_attraction_force(color1, color2):
    h1, s1, v1 = rgb_to_hsv(*(c / 255 for c in color1))
    h2, s2, v2 = rgb_to_hsv(*(c / 255 for c in color2))

    hue_diff = abs(h1 - h2)
    saturation_diff = abs(s1 - s2)

    attraction_strength = (1 - hue_diff) * (1 - saturation_diff)
    attraction_force = 0.0002 * attraction_strength

    return attraction_force

def get_scale_factor(z, depth):
    return 1 - (z / depth)

def average_glob_hsv(globs):
    if len(globs) == 0:
        return (0, 0, 0)  # default background color if there are no globs

    num_globs = len(globs)
    total_h, total_s, total_v = 0, 0, 0
    for glob in globs:
        h, s, v = rgb_to_hsv(*(c / 255 for c in glob.color))
        total_h += h
        total_s += s
        total_v += v

    avg_h = total_h / num_globs
    avg_s = total_s / num_globs
    avg_v = total_v / num_globs

    return avg_h, avg_s, avg_v

def get_random_color():
    r = random.randint(100, 255)
    g = random.randint(100, 255)
    b = random.randint(100, 255)
    return (r, g, b)

def main():
    global start
    pygame.init()
    screen = pygame.display.set_mode((WIDTH, HEIGHT))
    pygame.display.set_caption("Nia.S & ChatGPT's Lavalamp")
    clock = pygame.time.Clock()

    a, b, c = WIDTH / 2, HEIGHT / 2, DEPTH / 2

    globs = [Glob(*random_point_on_ellipsoid(a, b, c),
                  random.uniform(MIN_RADIUS, MAX_RADIUS),
                  get_random_color(),
                  str(uuid.uuid4())) for _ in range(INITIAL_GLOBS)]

    # Initialize the glob sets with the initial globs
    glob_sets = {i: {glob} for i, glob in enumerate(globs)}

    # Initialize audio mixer
    pygame.mixer.init(frequency=SAMPLE_RATE, size=BIT_DEPTH, channels=NUM_CHANNELS + 1, buffer=AUDIO_BUFFER_SIZE)
    channel_group1 = pygame.mixer.Channel(0)
    channel_group2 = pygame.mixer.Channel(NUM_CHANNELS - 1)


    # Generate initial buffers for both intervals
    buffers1 = [generate_next_buffer(globs) for _ in range(3)]
    buffers2 = [generate_next_buffer(globs) for _ in range(3)]

    buffer_index1 = 0
    buffer_index2 = 0
    prev_buffer1 = buffers1[buffer_index1]
    prev_buffer2 = buffers2[buffer_index2]

    running = True
    while running:

        # Update background color
        try:
            avg_h, avg_s, avg_v = average_glob_hsv(globs)
            bg_color = tuple(int(c * 255) for c in hsv_to_rgb(1 - avg_h, 1 - avg_s, 1 - avg_v))
            screen.fill(bg_color)
            last_valid_bg_color = bg_color
        except ValueError:
            if last_valid_bg_color is not None:
                screen.fill(last_valid_bg_color)
            else:
                r, g, b = bg_color
                avg_value = (r + g + b) // 3
                default_color = (64, 64, 64) if avg_value >= 128 else (255, 255, 255)
                screen.fill(default_color)

        # Event handling
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                running = False
                pygame.quit()

            if event.type == pygame.KEYDOWN:
                if event.key == pygame.K_f:
                    if screen.get_flags() & pygame.FULLSCREEN:
                        pygame.display.set_mode((WIDTH, HEIGHT))
                    else:
                        pygame.display.set_mode((WIDTH, HEIGHT), pygame.FULLSCREEN)

        new_globs = []

        # Sort globs based on z-axis
        sorted_globs = sorted(globs, key=lambda g: g.z, reverse=True)

        # Attract smaller globs to the nearest larger glob
        attract_smaller_globs(globs, MIN_RADIUS)

        # Draw globs in order of z-axis
        for glob in sorted_globs:
            result = glob.update(globs, glob_sets)
            if result:
                new_globs.extend(result)

            glob.draw(screen, bg_color)

        # Update and play audio buffers for both intervals
        prev_buffer1 = play_buffer(channel_group1, buffers1[buffer_index1], prev_buffer1)
        buffer_index1 = (buffer_index1 + 1) % 3
        buffers1[buffer_index1] = generate_next_buffer(globs)

        prev_buffer2 = play_buffer(channel_group2, buffers2[buffer_index2], prev_buffer2)
        buffer_index2 = (buffer_index2 + 1) % 3
        buffers2[buffer_index2] = generate_next_buffer(globs)

        # Update the display and tick the clock
        pygame.display.flip()
        clock.tick(FPS)

        # Add new globs to the list
        globs.extend(new_globs)

        # Remove globs that have radius less than 1
        globs = [glob for glob in globs if glob.radius >= 1]

        # Update the num_globs attribute of all globs
        num_globs = len(globs)
        for glob in globs:
            glob.num_globs = num_globs

    pygame.quit()

if __name__ == "__main__":
    main()

